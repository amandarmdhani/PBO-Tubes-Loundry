<!DOCTYPE html>
<html lang="id" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Clothers Laundry</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.theme.default.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/navbar.css}" />
    <link rel="stylesheet" th:href="@{/css/footer.css}" />
    <link rel="stylesheet" th:href="@{/css/dashboarduser.css}" />
</head>

<body>
    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <main class="main-content">
        <header class="hero-section">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-lg-6 hero-text-content">
                        <h1 class="hero-title">Solusi Laundry Cepat & Terpercaya</h1>
                        <p class="hero-subtitle">Nikmati pakaian bersih, wangi, dan rapi tanpa repot. Kami siap melayani Anda dengan kualitas terbaik.</p>
                        <a href="#plans" class="btn btn-primary btn-lg hero-cta">Lihat Layanan Kami</a>
                    </div>
                    <div class="col-lg-6 text-center">
                        <img th:src="@{/img/logo.png}" alt="Ilustrasi Laundry" class="hero-image">
                    </div>
                </div>
            </div>
        </header>

        <section class="features-section">
            <div class="container">
                <div class="row g-4">
                    <div class="col-md-4 animate-on-scroll">
                        <div class="feature-card">
                            <div class="feature-icon"><i class="fas fa-tshirt"></i></div>
                            <h3 class="feature-title">Pencucian Profesional</h3>
                            <p class="feature-description">Menggunakan teknologi modern untuk hasil bersih maksimal.</p>
                        </div>
                    </div>
                    <div class="col-md-4 animate-on-scroll">
                        <div class="feature-card">
                            <div class="feature-icon"><i class="fas fa-truck"></i></div>
                            <h3 class="feature-title">Antar-Jemput</h3>
                            <p class="feature-description">Layanan praktis untuk kenyamanan Anda di rumah.</p>
                        </div>
                    </div>
                    <div class="col-md-4 animate-on-scroll">
                        <div class="feature-card">
                            <div class="feature-icon"><i class="fas fa-check-circle"></i></div>
                            <h3 class="feature-title">Garansi Kepuasan</h3>
                            <p class="feature-description">Kami menjamin kualitas layanan atau cuci ulang gratis.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="services-section" id="plans">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title animate-on-scroll">Layanan Kami</h2>
                    <p class="section-subtitle animate-on-scroll">Pilih paket yang paling sesuai dengan kebutuhan Anda.</p>
                </div>
                
                <div class="owl-carousel product-carousel owl-theme">
                    <div th:each="product : ${products}" class="item animate-on-scroll">
                        <div class="service-card">
                            <div class="service-card-img-container">
                                <th:block th:if="${product.imageUrl != null and !product.imageUrl.isEmpty()}">
                                    <img th:src="@{${product.imageUrl}}" alt="Gambar Produk" class="service-card-img">
                                </th:block>
                                <th:block th:unless="${product.imageUrl != null and !product.imageUrl.isEmpty()}">
                                    <i class="fas fa-tshirt default-icon"></i>
                                </th:block>
                            </div>
                            <div class="service-card-body">
                                <h3 class="service-card-title" th:text="${product.name}">Nama Produk</h3>
                                <p class="service-card-category" th:text="${product.category}">Kategori</p>
                                <ul class="service-card-description">
                                    <li th:each="desc : ${#strings.arraySplit(product.description, '|')}" th:text="${desc}"></li>
                                </ul>
                            </div>
                            <div class="service-card-footer">
                                <p class="service-card-price" th:text="'Rp ' + ${#numbers.formatDecimal(product.price, 0, 'POINT', 0, 'COMMA')} + '/kg'"></p>
                                <button class="btn btn-secondary cta" th:attr="data-service=${product.name}, data-price=${product.price}">Pesan</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="testimonial-section" id="testimoni">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title animate-on-scroll">Apa Kata Mereka?</h2>
                    <p class="section-subtitle animate-on-scroll">Pengalaman pelanggan yang telah memercayai kami.</p>
                </div>
                <div class="owl-carousel testimonial-carousel owl-theme">
                    <div class="item">
                        <div class="testimonial-card">
                            <i class="fas fa-quote-left quote-icon"></i>
                            <p class="testimonial-text">"Clothers sangat membantu! Layanan cepat dan pakaian saya selalu wangi dan rapi."</p>
                            <div class="testimonial-author">- Sarah, Jakarta</div>
                        </div>
                    </div>
                    <div class="item">
                        <div class="testimonial-card">
                            <i class="fas fa-quote-left quote-icon"></i>
                            <p class="testimonial-text">"Antar-jemputnya praktis sekali. Kualitas cuciannya juga luar biasa, sangat bersih."</p>
                            <div class="testimonial-author">- Andi, Bandung</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="modal" class="modal-overlay">
        <div class="modal-box">
            <button type="button" class="btn-close close" aria-label="Close"></button>
            <h2 id="modal-title" class="modal-title">Judul Layanan</h2>
            <div class="modal-body">
                <div class="form-group">
                    <label for="kg-input">Jumlah (kg)</label>
                    <input type="number" id="kg-input" class="form-control" min="1" value="1" />
                </div>
                <div class="form-group">
                    <label>Metode Pengantaran</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="delivery" id="deliv1" value="0" checked>
                        <label class="form-check-label" for="deliv1">Ambil Sendiri (Gratis)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="delivery" id="deliv2" value="3000">
                        <label class="form-check-label" for="deliv2">Antar ke Rumah (+Rp 3.000)</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="payment-select">Metode Pembayaran</label>
                    <select id="payment-select" class="form-select">
                        <option value="cod" selected>COD (Bayar di Tempat)</option>
                        <option value="transfer">Transfer Bank</option>
                        <option value="ewallet">E-Wallet</option>
                    </select>
                </div>
                <div id="bank-options" class="form-group" style="display:none;">
                    <label for="bank-select">Pilih Bank</label>
                    <select id="bank-select" class="form-select">
                        <option value="">-- Pilih --</option><option value="bca">BCA</option><option value="mandiri">Mandiri</option><option value="bni">BNI</option>
                    </select>
                </div>
                <div id="ewallet-options" class="form-group" style="display:none;">
                    <label for="ewallet-select">Pilih E-Wallet</label>
                    <select id="ewallet-select" class="form-select">
                        <option value="">-- Pilih --</option><option value="gopay">Gopay</option><option value="ovo">OVO</option><option value="dana">Dana</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <p class="total-price-text">Total: <span id="total-price">Rp 0</span></p>
                <button class="btn btn-primary w-100 confirm-btn">Konfirmasi Pesanan</button>
            </div>
        </div>
    </div>

    <div th:replace="~{fragments/footer :: footer-user}"></div>

    <a href="#" id="scrollTopBtn" class="scroll-top-btn" title="Kembali ke atas">
        <i class="fas fa-arrow-up"></i>
    </a>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>

    <script th:inline="javascript">

    $(document).ready(function() {

        $('.product-carousel').owlCarousel({
            loop: true, margin: 24, nav: true, dots: true,
            onInitialized: function() {
                $('.product-carousel .owl-item').each(function(index) {
                    $(this).find('.animate-on-scroll').css('--owl-item-index', index);
                });
            },
            responsive: { 0: { items: 1 }, 576: { items: 2 }, 992: { items: 3 }, 1200: { items: 3 } }
        });

        $('.testimonial-carousel').owlCarousel({
            loop: true, margin: 24, nav: false, dots: true, autoplay: true,
            autoplayTimeout: 3000, autoplayHoverPause: true,
            responsive: { 0: { items: 1 }, 768: { items: 2 } }
        });

        setTimeout(() => { $('.hero-section').addClass('is-loaded'); }, 100);

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('is-visible');
                    observer.unobserve(entry.target);
                }
            });
        }, { threshold: 0.1 });
        document.querySelectorAll('.animate-on-scroll').forEach(el => observer.observe(el));

        const scrollTopBtn = document.getElementById('scrollTopBtn');
        if (scrollTopBtn) {
            window.addEventListener('scroll', () => {
                scrollTopBtn.classList.toggle('visible', window.scrollY > 300);
            });
            scrollTopBtn.addEventListener('click', (e) => {
                e.preventDefault();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }

        const modal = document.getElementById("modal");
        const modalTitle = document.getElementById("modal-title");
        const kgInput = document.getElementById("kg-input");
        const totalPriceEl = document.getElementById("total-price");
        const closeBtn = modal.querySelector(".close");
        const confirmBtn = modal.querySelector(".confirm-btn");
        const paymentSelect = document.getElementById('payment-select');
        const bankOptions = document.getElementById('bank-options');
        const ewalletOptions = document.getElementById('ewallet-options');

        let currentPrice = 0;
        let currentService = "";

        function updateTotalPrice() {
            const kg = parseInt(kgInput.value) || 0;
            const deliveryCost = parseInt(modal.querySelector('input[name="delivery"]:checked').value) || 0;
            const total = (currentPrice * kg) + deliveryCost;
            // PERBAIKAN: Menggunakan string concatenation untuk menghindari error linting
            totalPriceEl.textContent = 'Rp ' + total.toLocaleString("id-ID");
        }

        function updatePaymentOptions() {
            const selectedPayment = paymentSelect.value;
            bankOptions.style.display = selectedPayment === 'transfer' ? 'block' : 'none';
            ewalletOptions.style.display = selectedPayment === 'ewallet' ? 'block' : 'none';
        }

        $(document).on("click", ".cta", function() {
            currentService = $(this).data("service");
            currentPrice = parseInt($(this).data("price"));
            modalTitle.textContent = currentService;
            kgInput.value = 1;
            updateTotalPrice();
            updatePaymentOptions();
            modal.style.display = "flex";
        });

        kgInput.addEventListener("input", updateTotalPrice);
        modal.querySelectorAll('input[name="delivery"]').forEach(radio => radio.addEventListener('change', updateTotalPrice));
        paymentSelect.addEventListener('change', updatePaymentOptions);
        closeBtn.addEventListener("click", () => modal.style.display = "none");
        window.addEventListener("click", (e) => {
            if (e.target === modal) modal.style.display = "none";
        });

        confirmBtn.addEventListener("click", () => {
            const kg = parseInt(kgInput.value) || 0;
            if (kg <= 0) { alert("Jumlah kilogram harus lebih dari 0."); return; }
            
            const deliveryCost = parseInt(modal.querySelector('input[name="delivery"]:checked')?.value || 0);
            const paymentMethod = paymentSelect.value;
            const bankSelection = document.getElementById("bank-select").value;
            const ewalletSelection = document.getElementById("ewallet-select").value;
            let paymentDetail = "COD";
            
            if (paymentMethod === 'transfer') {
                if (!bankSelection) { alert("Silakan pilih bank terlebih dahulu."); return; }
                paymentDetail = bankSelection;
            } else if (paymentMethod === 'ewallet') {
                if (!ewalletSelection) { alert("Silakan pilih e-wallet terlebih dahulu."); return; }
                paymentDetail = ewalletSelection;
            }

            const total = (currentPrice * kg) + deliveryCost;
            const orderData = { service: currentService, kilogram: kg, deliveryCost, paymentMethod, paymentDetail, totalPrice: total };
            
            confirmBtn.classList.add('is-loading');
            
            
            const postOrderUrl = '/api/orders';
            
            fetch(postOrderUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData)
            })
            .then(res => {
                if (res.ok) {
                    return res.json();
                }
                return Promise.reject(res); 
            })
            .then(data => {
                const successMessage = 'Pesanan untuk ' + orderData.service + ' berhasil dibuat!\nTotal: Rp' + orderData.totalPrice.toLocaleString("id-ID");
                alert(successMessage);
                modal.style.display = "none";
            })
            .catch(err => {
                console.error("Fetch Error:", err);
                alert("Gagal mengirim pesanan ke server. Silakan coba lagi.");
            })
            .finally(() => {
                confirmBtn.classList.remove('is-loading');
            });
        });
    });
    /*]]>*/
    </script>
</body>
</html>
